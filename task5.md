## Задание №5 

## Использование GitLab в среде разработки

Перед выполнением задания необходимо выполнить [настройку виртуальной машины для работы с системой управления проектами](task_vm_prepare.md)

Если сдача задания осуществляется через issue необходимо чтобы проект на сервере был синхронизирован с тем проектов в котором вы работали, в issue добавлять скриншоты, демонстрирующие выполнение всех шагов задания. 

### Работа в CLion
1. **Запустить среду разработки CLion** - ярлык слева на панели (большие буквы CL). В зависмости от технических средств и того как работает виртуальная машина, этот процесс может занять некоторое время.

2. **Создание проекта в CLion**
    * New project, указываем путь к нашему репозиторию /home/user/Desktop/tpro
    * Появится сообщение "The directory... is not empty...":
        * При выборе no Clion за вас создат проект hello world (этот вариант, если у вас почти пустой репозиторий с readme). Нас этот вариант не интересует.
        * При выборе yes каталог откроется "как есть" (этот вариант, если вы скачали проект с кодом).
        * **выберите yes**
    * окно Tip of the day (Совет дня) содержит разные полезные горячие клавиши и функции IDE (Integraged Development Environment - интегрированная среда разработки). Можете ознакомиться с содержимым. Можете убрать галочку show tips on startup, чтобы окно больше не возникало.
    * Открытый проект будет одним проектом по учебной дисциплине. Мы всегда будем работать со всем проектом целиком, **никогда не создавайте отдельные проекты для каждого задания**. Любые задания, связанные с написанием программ в CLion, будут представлять из себя отдельный подкаталог в вашем репозитории tpro.

3. **Изменение проекта и синхронизация с репозиторием**
    * В появившемся окне слева вы можете увидеть структуру вашего проекта tpro и выбрав любой файл посмотреть его содержимое.
    * Выберите файл README.md и внесите в него изменения через CLION, сохраните изменения.
    * Перейдите в консоль и посмотрите текущий статус проекта ```git status```
    * Файл README.md изменился. Через консоль проиндексируйте файл и зафиксируйте изменения. Синхронизирутейсь с репозиторием на сервере.

    * В первое время рекомендуется таким образом работать с проектом, то есть все действия в системе контроля версий и синхронизацию проекта проводить через консоль.

4. **Работа над отдельной задачей проекта - подпроектом (практическим заданием)**
    * Для понимания работы с CLion и средством тестирования Catch, которое мы будем использовать в дальнейшем **создадим подпроект example**, это будет пример выполнения отдельной задания в проекте "tpro".
    * В дальнейшем будем отождестлять понятия **задание в проекте**, **подпроект проекта**, **подкаталог проекта**.
    * В проекте создайте каталог **example** (правой кнопкой мыши на tpro, new->directory). Возникнет сообщение "do you want add the following file to git". На первых порах при работе с git **крайне не рекомендуется пользоваться графическим интерфейсом**, поэтому поставьте галочку **remember**, **dont ask** и нажмите **cancel**.

5. **Копирование файлов в проект** 
    * Необходимо скачать из текущего репозитория дисциплины заголовочный файл фреймворка catch2 для тестирования и файлы примеров подпроекта example. Возпользуемся утилитой http, установленной в вашу виртуальную машину. В консоли выполните нижеприведеные команды.
    * После копирования первого файла проверьте его содержимое, если файлы содержат различные html-теги вида <><><>, состоящие из угловых скобок и слов HTML, HEAD, gitwork, sign_in, то это означает, что при копировании произошла ошибка, связанная с аутентификацией на сервере. Причин может быть несколько, от неправильно прописанного SSH-ключа до локальных проблем на сервере. В таком случае проверьте SSH-ключ (как указано ранее) или попробуйте второй вариант - копирование файлов из **проекта-примера**, который описан далее.
    
    ```bash
    # вы должны быть в /home/user/Desktop/tpro
    cd example
    http https://gitwork.ru/sub/tpro/-/raw/master/example/example.cpp --verify=no > example.cpp
    http https://gitwork.ru/sub/tpro/-/raw/master/example/example.h --verify=no > example.h
    http https://gitwork.ru/sub/tpro/-/raw/master/example/example_tests.cpp --verify=no > example_tests.cpp
    # это конфигурационный файл для проекта в git - убирает некоторые временные файлы из зрения git
    http https://gitwork.ru/sub/tpro/-/raw/master/example/.gitignore --verify=no > ../.gitignore
    # это фреймворк для тестирования
    http https://gitwork.ru/sub/tpro/-/raw/master/catch.hpp --verify=no > ../catch.hpp
    # это настроечный файл проекта, в нем указываются какие исполняемые модули собираются
    http https://gitwork.ru/sub/tpro/-/raw/master/CMakeLists.txt --verify=no > ../CMakeLists.txt
    ```
    
    Если вам доступен **проект-пример** https://gitwork.ru/klexey/timp-example , то можно загрузить файлы оттуда, обратите внимание, команду **"cd example"**, скорее всего, вам выполнять уже не надо. Проверить текущий каталог можно командой **"pwd"**. Он должен быть "/home/user/Desktop/tpro/example".
    
    ```bash
    # Если вы все еще находитесь в /home/user/Desktop/tpro, то выполните следующую команду
    cd example
    http https://gitwork.ru/klexey/timp-example/-/raw/master/example/example.cpp --verify=no > example.cpp
    http https://gitwork.ru/klexey/timp-example/-/raw/master/example/example.h --verify=no > example.h
    http https://gitwork.ru/klexey/timp-example/-/raw/master/example/example_tests.cpp --verify=no > example_tests.cpp
    # это конфигурационный файл для проекта в git - убирает некоторые временные файлы из зрения git
    http https://gitwork.ru/klexey/timp-example/-/raw/master/.gitignore --verify=no > ../.gitignore
    # это фреймворк для тестирования
    http https://gitwork.ru/klexey/timp-example/-/raw/master/catch.hpp --verify=no > ../catch.hpp
    # это настроечный файл проекта, в нем указываются какие исполняемые модули собираются
    http https://gitwork.ru/klexey/timp-example/-/raw/master/CMakeLists.txt --verify=no > ../CMakeLists.txt
    ```
    Если проблему устранить не удалось, то вручную загрузите файлы из проекта - какие файлы и откуда загружать, а также куда их помещать видно из параметров команд. 
    
 * Используя ```git add``` и ```git commit```, добавьте каталог example со всем его содержимым в git-репозиторий (git add example/*), затем все остальные файлы в каталоге tpro, результат ```git status``` не должен выдавать "цветных" файлов, после чего с помощью ```git push``` загрузите результаты на gitwork.ru.
    
6. **Настройка и запуск подпроекта (отдельного задания проекта)**
* Слева в списке содержимого проекта должны появится файлы, которые вы только что скопировали
* Правой кнопкой мыши нажмите на файл CMakeLists.txt, "Load (Reload) CMake Project". Это действие подготовит проект к сборке, создаст вспомогательные файлы. Обратите внимание, что не должно появляться никаких сообщений об ошибках в нижней части экрана. Наиболее распространенные ошибки связаны с наименованием файлов и указанием путей к ним. Для данного примера ошибок не должно возникать. После выполнения действия появится каталог cmake-build-debug, в котором в дальнейшем будут находится исполняемые файлы проекта.
* Необходимо создать "конфигурацию" для подпроекта example. "Конфигурация" в CLion, грубо говоря, - это атомарная единица, которую можно скомпилить. Их может быть несколько для всего вашего проекта, как одна конфигурация для каждого задания, так и несколько конфигураций для одного задания. Конфигурации бывают различных типов и по разному позволяют работать с подготовленным кодом, нас будети интересовать два типа конфигураций - "Application", для просто сокмпилированных приложений и "Catch" для наборов тестов разработанных нами модулей.
* Для создания конфигурации в CLion выполните "run" - "edit configurations". 
    Возможно конфигурация уже будет автоматически создана (название example_test), ее необходимо удалить (выбрать и нажать минус), затем создать заново (Это связано с тем, что созданная автоматически конфигурация работает в режиме "Application", а нам необходим режим "Catch", который позволяет более гибко подходить к вопросам тестирования, поскольку приведенный пример содержит именно тесты).
    Слева вверху нажмите плюс, выберите catch.
    * name - example_test 
    * target - example_test (то, что указано в add_executable в CMakeLists.txt)
    * ok
* Запустите run - run. Отработавшие тесты выдадут 0 в окно `run` и tests passed: 2 в окно `event log` (справа-снизу).

* Вы успешно настроили конфигурацию для подпроекта example_test, скомпилировали и запустили её.

**скриншот** должен содержать вывод результатов тестирования в нижней части CLion, а также содержимое файла с тестами в верхней части.
 
7. **Содержимое подпроекта**
* Давайте еще раз посмотрим содержимое **подпроекта example**. Данный подпроект - это пример отдельного задания, выполняемого вами в рамках проекта `tpro`.
* В данном подпроекте присутствуют следующие файлы, необходимые для компиляции подпроекта:
	*  example.cpp - файл, содержащий код, реализующий функционал модуля `example`, в данном примере - там реализована функция суммирования `sum`.
	*  example.h - заголовочный файл, содержащий описание функций модуля `example` для возможности их использования.
	*  example_tests.cpp - файл с тестами для модуля `example`, данный файл написан с использованием функций тестирования `Catch` и имеет свой формат представления.
*  В данном подпроекте компилируемыми файлами являются файлы `example.cpp` и `example_test.cpp`.
*  Ваш проект может содержать несколько подпроектов, каждый из которых является выполнением отдельного задания.

8. **CMakeLists.txt - файл конфигурации для сборки**
* Данный файл содержит перечень подпроектов проекта, которые можно отдельно скомпилировать, если говорить точнее, то данный файл содержит перечень не самих подпроектов, а конфигураций для сборки, потому что для каждого подпроекта можно создать несколько конфигураций для сборки (компилирования), например debug или release, а также вариант программы, использующей модуль, или программы, тестирующей модуль, и другие варианты.
* Каждая конфигурация описывается начиная со слова `add_executable`
* Кроме конфигураций в файле `CMakeLists.txt` указываются параметры для работы, версии стандартов и т.п., на текущий момент нам устраивают те параметры, которые там указаны, будем менять только описание самих конфигураций.
* Конфигурация описывает те файлы, которые компилируются при сборке данной конфигурации
* Конфигурация описывается следующим образом (таких строк может быть несколько)
  
    `add_executable(name file1.cpp file2.cpp file3.cpp ...)`
    
    где

    `name` - название конфигурации, которое будет использоваться в дальнейшем

    `file1.cpp`, `file2.cpp` и т.д. - перечисление файлов, которые будут компилироваться в соответствующей конфигурации `name`, как правило здесь указываются все файлы `.cpp`, но и указание файлов `.h` или `.hpp` не вызовет ошибки. Например, CLion добавляет сюда автоматически все файлы подпроекта.

* Распространенной ошибкой является указание "лишних" файлов `.cpp` в перечне конфигурации, которые на самом деле в этой конфигурации не используются, что приводит к ошибкам компиляции или линковки.
* На текущий момент времени у вас должна быть одна конфигурация, которая называется `example_test`, и в которую включены компилируемые файлы `example.cpp` и `example_tests.cpp`, находящиеся в каталоге `example` - указываются относительные имена файлов вида `example/example.cpp` 

9. **Ошибки при тестировании**
* Теперь для примера давайте добавим в проект ошибку, чтобы посмотреть как будет выглядеть эта ошибка при тестировании с использованием `Catch`, ошибку будем добавлять не в сам код, а в тест, потому что неправильный тест, будет считать что в верном коде содержится ошибка. Поэтому всегда когда обнаружена ошибка необходимо понять, где эта ошибка - в коде или в тестах.
* Более подробное описание тестирования с использованием `Catch` будет в задании по тестированию, а сейчас просто добавим ошибку
* В файле с тестами `exmaple_tests.cpp` содержатся два набора тестов, они описываются с помощью ключевых слов `TEST_CASE`, обратите внимание на параметры `TEST_CASE` - первый это **уникальное** название набора тестов `test1` `test2`, второй - группа тестов, которая может повторяться `testgroup1`, которая указывается в квадратных скобках
* Создадим новый набор тестов с ошибкой, для этого скопируйте первый `TEST_CASE` и переименуйте его в `test3`.
* Далее внесите в тест ошибки, например, измените знак `==` на `!=`, и наоборот, что будет означать, что тест проверяет, что сумма 5 и 10 не равна 15, что неверно.
* Скомпилируйте данную конфигурацию и запустите, посмотрите как будет отображаться ошибка, какая информация будет отображаться в окнах `run` и `event log` в текущей ситуации, когда часть тестов пройдет, а часть выполнится с ошибкой. 
 
**скриншот** должен содержать вывод результатов тестирования в нижней части CLion, а также содержимое файла с тестами в верхней части.

10. **Создание новой конфигурации**
* Итак в вашем файле сейчас находится конфигурация `example_test` для тестирования модуля `example.cpp`
* Создадим программу, которая будет использовать модуль `example.cpp`, для этого через CLion создайте в каталоге `example` новый файл `main.cpp` (как C++ source file). Уберите галочку "add to targets" (Данный функционал можно изучить позднее).
* Содержимое файла main.cpp - выведите на экран "hello world" и результат функции сложения для некоторой пары чисел (функцию сложения использовать из example.cpp).
* Для того чтобы запустить новую программу опишите для нее новую конфигурацию, для этого в CMakeLists.txt добавьте строку

    ```
    add_executable(example_main example/main.cpp example/example.cpp)
    ```

* Перезагрузите CMake файл. 
* Теперь ваш проект содержит две конфигурации - одна для тестирования модуля - `example_tests`, вторая для непосредственно работы с модулем - `example_main`.
* Распространенной ошибкой является указание "лишних" файлов `.cpp` в перечне файлов конфигурации, которые на самом деле в этой конфигурации не используются. Это может привести к ошибкам компиляции или линковки, когда среди файлов может оказаться два файла, содержащих функцию main(), например файл с тестами включает в себя библиотеку `catch.hpp`, которая содержит внутри себя функцию main(), значит одновременное наличие файлов `example_tests.cpp` и `main.cpp` в одной конфигурации приведет к ошибке.
* **Создайте новую конфигурацию (Run -> Edit Configurations, слева сверху плюсик)** для `application` (где ранее выбирали **Catch**, теперь выберите **Application**) - `example_main`. Запустите `example_main`, убедитесь в наличии вывода на экран правильной информации из вашего файла `main.cpp`. 

**скриншот** должен содержать вывод результатов работы программы в нижней части CLion, а также содержимое файла с функцией main() в верхней части. 

    
Теперь вы умеете запускать произвольный код (`main.cpp`) и тесты (`example_test.cpp`) для некоторой созданного вами модуля (`example.cpp`). Различные особенности `catch2` доступны [в документации](http://gitwork.ru/anetto/catch2/blob/master/README.md).

### P.S.

* CLion имеет определенные средства автоматизации тех действий, которые произведены вручную в рамках данного задания, на первых порах рекомендуется делать все "вручную", чтобы понять механизм работы.

* **Добавление файлов и каталогов в Git**. При создании файлов или каталогов, появляется сообщение "do you want add the following file to git", если согласиться, то добавляемый файл или каталог будет сразу проиндексирован - аналогично команде `git add`.
* **Добавление файлов в конфигурацию**.  При создании файлов можно их сразу добавлять в конфигурацию, а не вручную прописывать в CMakeLists.txt. Для этого при создании файлов можно согласиться с предложением "add to targets" и выбрать необходимую конфигурацию.
* **Работа с СКВ Git через графический интерфейс CLion**. В CLion можно работать с Git без использования консоли. Если открыть консоль и ввести команду **git status**, то можно увидеть цветовое обозначение текущего состояния файлов: зеленые - проиндексированные файлы, красные - измененные или неотслеживаемые файлы. Если открыть проект в CLion и посмотреть на список файлов проекта, то можно увидеть, что файлы имеют почти такую же цветовую раскраску, как и в результате команды **git status** с небольшими отличиями. CLion отображает текущее состояние файлов в репозитории проекта, кроме того, нажав правой клавишей на файл, в выпадающем меню можно найти подменю `Git` и в нем будут все действия, например, `Add`, `Commit` и т.п. При выборе `Commit` можно выбрать какие файлы будут включен в коммит. Кроме того, данные команды доступны из меню вверху программы, а также доступны в правом верхнем углу, как быстрые кнопки. И, конечно, существуют "горячие клавиши" для вызова этих действий.  
* Это означает, что вы можете работать с репозиторием, непосредственно из CLion, но первое время, **рекомендуется использовать консоль**.